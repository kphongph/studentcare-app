<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/vaadin-icons/vaadin-icons.html">

<!--<link rel="import" href="document-loader.html">-->

<link href="https://fonts.googleapis.com/css?family=Itim&amp;subset=thai" rel="stylesheet">
<script src="../bower_components/kjur-jsrsasign/jsrsasign-all-min.js"></script>

<dom-module id="login-box">
  <template>
  <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors">
    :host {
      @apply(--layout-vertical);
      color:#000;
      --paper-input-container-label: {
        font-family: 'Itim', cursive;
      };
      --paper-input-container-input: {
        font-family: 'Itim', cursive;
      }
    }

    .sign-bar{
      margin-top: 20px;
      height: 250px;
      width: 250px;
      background-color: #eee;
    }

    .head-ber{
      height: 30px;
      background-color: #2a363b;
    }

    .layout-center{
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }

    paper-input{
      font-family: 'Itim', cursive;
    }

    paper-button{
      font-family: 'Itim', cursive;
      background-color: #00bbd3;
      color: #fff;
    }
  </style>

  <div class="layout horizontal layout-center">
    <div class="layout vertical sign-bar" hidden$="{{signed}}">
      <div class="layout horizontal head-ber">&nbsp;</div>
      <div class="layout horizontal layout-center">
        <paper-input label="User ID" value="{{user}}"></paper-input>
      </div>
      <div class="layout horizontal layout-center">
        <paper-input label="Password" type="password" value="{{pass}}"></paper-input>
      </div>
      <div class="layout horizontal layout-center">
        <span>{{_message}}</span>
      </div>
      <div class="layout horizontal layout-center">
        <paper-button raised on-tap="_signIn">Sign in</paper-button>
      </div>
    </div>
  </div>

  <iron-ajax
    id="loginAjax"
    url="/login"
    method="POST"
    on-response="_onResponse"
    content-type="application/json"
    body$='{"user":"{{user}}","pass":"{{pass}}"}'>
  </iron-ajax>


  <iron-ajax
    id="getRoleAjax"
    url="https://maas.nuqlis.com:8000/v2/cores/role_db/query"
    method="POST"
    on-response="_onRoleResponse"
    content-type="application/json"
    body$='{"query":{"user":"{{user}}","application":"student-care"}}'>
  </iron-ajax>

  <app-localstorage-document
    id="storage"
    key="jwtToken"
    data="{{token}}">
  </app-localstorage-document>

  <app-localstorage-document
    key="role"
    data="{{role}}">
  </app-localstorage-document>

 </template>

 <script>
  Polymer({
    is:'login-box',
    properties:{
     token: {
       type:Object,
       value:{}
     },
     role: {
       type:Object,
       notify:true,
       value:function() {
         return {};
       }
     },
     signed:{
       type:Boolean,
       notify:true,
       reflectToAttribute:true,
       computed:'_computeSigned(token)'
     }
    },
    _signIn:function(e) {
      this.$.loginAjax.generateRequest();
    },
    signOut:function(e) {
      this.set('token',{});
      this.set('role',{});
    },
    _computeSigned:function(token) {
      return token.token != null;
    },
    _onRoleResponse:function(e) {
      var response = e.detail.response;
      if(response.length == 1) {
        var doc = response[0];
        this.set('role',doc);
      }
    },
    /*
    _updateRole:function(e) {
      //console.log(e.detail);
      if(e.detail.data.length >= 1) {
        //console.log(e.detail.data[0]);
        this.set('role',e.detail.data[0].value);
      }
    },
    */
    _onResponse:function(e) {
      var res = e.detail.response;
      if(res.success) {
        this.set('token',{'token':res.token});
        this.set('_message','');
        // get role
        this.$.getRoleAjax.headers = {
          'Authorization':'JWT '+res.token
        };

        this.$.getRoleAjax.generateRequest();
      } else {
        this.set('_message','Invalid User/Password');
      }
    }
  });
  </script>
</dom-module>
