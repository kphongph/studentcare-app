<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<dom-module id="teacher-app">
 <template>
  <style include="iron-flex iron-flex-alignment iron-flex-factors">
    :host {
      display:box;
      @apply(--layout-vertical);
      @apply(--paper-font-body2);
      padding:5px;
    }
    paper-tabs {
      background:var(--paper-blue-500);
      color:#ffffff;
    }
    paper-progress {
      padding:5px;
    }
  </style>
  <app-localstorage-document 
    key="jwtToken" 
    data="{{token}}">
  </app-localstorage-document>

  <iron-ajax 
    id="requestAjax"
    url="https://maas.nuqlis.com:9000/api/query/students_care/host_info"
    method="POST"
    content-type="application/json"
    headers$='{"authorization":"JWT {{token.token}}"}'
    body$='{"match":["{{host}}"]}'
    on-response="_onResponse">
  </iron-ajax>

  <iron-ajax 
    id="listAllAjax"
    url="https://maas.nuqlis.com:9000/api/query/dmc59_1/hostid"
    method="POST"
    content-type="application/json"
    headers$='{"authorization":"JWT {{token.token}}"}'
    body$='{"match":["{{host}}"],"limit":-1}'
    on-response="_listAllResponse">
  </iron-ajax>
  <div>Teacher App</div>
  <div>{{host}}</div>
  <template is="dom-repeat" items="{{messages}}">
  <div>{{item}}</div>
  </template>

  <div class="layout horizontal center">
  <template is="dom-if" if="{{loading}}">
    (<span>{{_studentLoaded}}</span>/
     <span>{{_studentTotal}}</span>)
    <paper-progress value="{{_studentLoaded}}" max="{{_studentTotal}}">
  </template>
  </div>

  <paper-tabs selected="{{selectedLevel}}" 
    attr-for-selected="name" scrollable>
    <template is="dom-repeat" items="{{_levels}}">
      <paper-tab name="{{item.level}}">{{item.label}}</paper-tab>
    </template>
  </paper-tabs>

  <iron-pages selected="{{selectedLevel}}"
    attr-for-selected="name">
    <template is="dom-repeat" items="{{_levels}}" as="level">
      <div name="{{level.level}}" class="layout vertical">
        <div class="layout horizontal center">
          <div class="flex-1">Room</div>
          <div class="flex-1">Students</div>
          <div class="flex-2">Class Teacher</div>
        </div>
        <template is="dom-repeat" items="{{level.room}}">
          <div class="layout horizontal center">
            <div class="flex-1">{{item.room}}</div>
            <div class="flex-1">{{item.student}}</div>
            <div class="flex-2">Class Teacher</div>
          </div>
        </template>
      </div>
    </template>
  </iron-pages>
    

  <div class="layout horizontal center">
  <paper-button raised on-tap="_reload">Reload</paper-button>
  </div>
  
  
 </template>
 <script>
  Polymer({
   is: 'teacher-app',
   properties:{
     host:{
       type:String
     },
     hostInfo:{
       type:Object,
       notify:true,
       value:{
        'value':{
          'doc_type':'host_info',
          'dmc':{},
          'level':{}
        }
       }
     },
     _levels:{
       type:Array,
       computed:'__computeLevels(hostInfo)'
     },
     loading: {
       type:Boolean,
       notify:true,
       value:false
     },
     messages:{
       type:Array,
       notify:true,
       value:[]
     }
   },
   observers:[
    '_tokenLoaded(token)'
   ],
   _tokenLoaded:function(token) {
     if(token && token.token != null) {
       this.$.requestAjax.generateRequest();
     }
   },
   _onResponse:function(e) {
     var response = e.detail.response;
     var self = this;
     if(response.length == 0) {
       this.push('messages','- Not Found Host Information');
       this.$.listAllAjax.generateRequest();
       this.push('messages','- Loading Student Information');
     } else {
       this.push('messages','- Found Host Information');
       this.push('messages','- Loading Host Information');
       var ele = document.createElement('iron-request');
       var key = response[0].value;
       ele.send({
         url:'https://maas.nuqlis.com:9000/api/dbs/students_care/'+key,
         method:'GET',
         handleAs:'json',  
         headers:{
           'authorization':'JWT '+this.token.token
         }
       }).then(function(res) {
         self.set('hostInfo',{'key':key,'value':res.response});
       });
     }
   },
   __computeLevels:function(hostInfo) {
     var result = [];
     var dict = ['K','E','S'];
     var level = hostInfo.value.level;
     for(var key in level) {  
       var tmp = {'level':key,'room':[]}; 
       var intLevel = Number(key);
       if(intLevel<=15) tmp['label']=dict[2]+' '+(intLevel-9);
       if(intLevel<=9) tmp['label']=dict[1]+' '+(intLevel-3);
       if(intLevel<=3) tmp['label']=dict[0]+' '+intLevel;
       for(var room in level[key]) {
         tmp['room'].push({'room':room,'student':level[key][room]});
       }
       result.push(tmp);
     }
     result.sort(function(a,b) {
       return Number(a.level)>=Number(b.level)?1:-1; 
     });
     return result;
   },
   _listAllResponse:function(e) {
     var response = e.detail.response;
     this.set('_studentTotal',response.length);
     this.push('messages','- Found '+response.length+' students');
     this.push('messages','- Loading');
     this.set('loading',true);
     this.__loadStudent(response,0);
   },
   __loadStudent:function(list,index) {
     var self = this;
     if(index>=list.length) {
       this.hostInfo.value['dmc']['host'] = this.host;
       var ele = document.createElement('iron-request');
       var url = 'https://maas.nuqlis.com:9000/api/dbs/students_care/';
       if(this.hostInfo.key && this.hostInfo.key!=null) {
         url+=this.hostInfo.key;
       }
       ele.send({
         url:url,
         method:'POST',
         handleAs:'json',  
         body:JSON.stringify(this.hostInfo.value),
         headers:{
           'content-type':'application/json',
           'authorization':'JWT '+this.token.token
         }
       }).then(function(res) {
         self.set('hostInfo',{'key':self.hostInfo.key,'value':self.hostInfo.value});
         console.log(res.response);
       });
     } else {
       var self= this;
       var ele = document.createElement('iron-request');
       var key = list[index].value;
       ele.send({
         url:'https://maas.nuqlis.com:9000/api/dbs/dmc59_1/'+key,
         method:'GET',
         handleAs:'json',  
         headers:{
           'authorization':'JWT '+this.token.token
         }
       }).then(function(res) {
         var student = res.response;
         var level = self.hostInfo.value.level;
         if(!level[student.LEVEL]) {
           level[student.LEVEL] = {};
         }
         if(!level[student.LEVEL][student.CLASSROOM]) {
           level[student.LEVEL][student.CLASSROOM] = 0; 
         }
         level[student.LEVEL][student.CLASSROOM]++;
         self.set('_studentLoaded',index+1);
         self.__loadStudent(list,index+1);
       });
     }
   },
   _reload:function(e) {
     this.set('messages',[]);
     this.set('hostInfo.value.level',{});
     this.notifyPath('hostInfo');
     this.push('messages','- Reload');
     this.$.listAllAjax.generateRequest();
   }
  });
 </script>

</dom-module>
